# GitHub Actions 워크플로우 이름
name: Jib CI/CD (No Server Script)

# main 브랜치에 push 될 때만 실행
on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) GitHub 저장소 코드 체크아웃
      - uses: actions/checkout@v4

      # 2) JDK 17 세팅 (Jib 빌드용)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      # 3-1) Spring Boot / Java 프로젝트 빌드
      - name: Build project with Maven
        run: mvn -B clean package

      # 3-2) Jib으로 Docker 이미지 TAR 생성
      # 결과물: target/myapp.tar
      - name: Build image tar with Jib
        run: mvn -B jib:buildTar

      # 4) SSH 키 파일 생성
      # ⚠️ 반드시 GITHUB_WORKSPACE 에 생성 (컨테이너와 공유됨)
      - name: Create SSH key
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > $GITHUB_WORKSPACE/id_rsa
          chmod 600 $GITHUB_WORKSPACE/id_rsa

      # 5) 생성된 myapp.tar 파일을 서버로 전송 (SCP)
      - name: Copy image tar to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key_path: /github/workspace/id_rsa
          source: "target/myapp.tar"
          target: "/home/ubuntu"

      # 6) 서버에 SSH 접속해서 Docker 명령 실행
      - name: Run container on server (no script)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key_path: /github/workspace/id_rsa
          script: |
            # 이미지 로드
            sudo docker load < /home/ubuntu/myapp.tar

            # 기존 컨테이너 중지 (없으면 무시)
            sudo docker stop myapp || true

            # 기존 컨테이너 삭제 (없으면 무시)
            sudo docker rm myapp || true

            # 새 컨테이너 실행
            sudo docker run -d \
              --name myapp \
              -p 8080:8080 \
              --restart unless-stopped \
              myapp

            # 사용하지 않는 이미지 정리
            sudo docker image prune -f
